name: Codex Quality Check (Multi-Language)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install Python linters
      run: |
        python -m pip install --upgrade pip
        pip install pylint black flake8 autoflake libcst mypy bandit
      continue-on-error: true
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
      continue-on-error: true
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install JavaScript/TypeScript tools
      run: |
        # Install global tools
        npm install -g eslint prettier typescript @typescript/eslint-parser
        
        # Create basic ESLint config if missing
        if [ ! -f .eslintrc.js ] && [ ! -f .eslintrc.json ] && [ ! -f .eslintrc ]; then
          cat > .eslintrc.js << 'EOF'
          module.exports = {
            env: {
              browser: true,
              es2021: true,
              node: true
            },
            extends: [
              'eslint:recommended'
            ],
            parserOptions: {
              ecmaVersion: 'latest',
              sourceType: 'module'
            },
            rules: {
              'no-unused-vars': 'warn',
              'no-console': 'off'
            },
            overrides: [
              {
                files: ['**/*.ts', '**/*.tsx'],
                parser: '@typescript-eslint/parser',
                extends: [
                  'eslint:recommended'
                ],
                rules: {
                  'no-unused-vars': 'off'
                }
              }
            ]
          };
          EOF
          echo "Created basic ESLint config"
        fi
        
        # Create basic Prettier config if missing
        if [ ! -f .prettierrc ] && [ ! -f .prettierrc.js ] && [ ! -f .prettierrc.json ]; then
          cat > .prettierrc << 'EOF'
          {
            "semi": true,
            "singleQuote": true,
            "tabWidth": 2,
            "trailingComma": "es5",
            "printWidth": 100
          }
          EOF
          echo "Created basic Prettier config"
        fi
      continue-on-error: true
    
    - name: Install Go tools
      run: |
        # Install essential Go linters and tools
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install golang.org/x/tools/cmd/goimports@latest
        go install github.com/mgechev/revive@latest
        go install honnef.co/go/tools/cmd/staticcheck@latest
        
        # Add Go bin to PATH
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      continue-on-error: true
    
    - name: Run pre-analysis language detection
      id: detect_languages
      run: |
        echo "üîç Detecting project languages..."
        
        LANGUAGES=()
        
        # Check for Python files
        if find . -name "*.py" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          LANGUAGES+=("python")
          echo "üìÅ Found Python files"
        fi
        
        # Check for JavaScript/TypeScript files
        if find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          LANGUAGES+=("javascript")
          echo "üìÅ Found JavaScript/TypeScript files"
        fi
        
        # Check for Go files
        if find . -name "*.go" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./vendor/*" | grep -q .; then
          LANGUAGES+=("golang")
          echo "üìÅ Found Go files"
        fi
        
        # Check for other common languages
        if find . -name "*.java" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          LANGUAGES+=("java")
          echo "üìÅ Found Java files"
        fi
        
        if find . -name "*.cpp" -o -name "*.c" -o -name "*.h" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          LANGUAGES+=("cpp")
          echo "üìÅ Found C/C++ files"
        fi
        
        if find . -name "*.rb" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          LANGUAGES+=("ruby")
          echo "üìÅ Found Ruby files"
        fi
        
        LANGUAGES_STR=$(IFS=,; echo "${LANGUAGES[*]}")
        echo "languages=$LANGUAGES_STR" >> $GITHUB_OUTPUT
        echo "detected_languages=$LANGUAGES_STR" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Detected languages: $LANGUAGES_STR"
    
    - name: Run language-specific linters
      continue-on-error: true
      run: |
        echo "üîß Running language-specific quality checks..."
        mkdir -p reports
        
        # Python checks
        if echo "${{ steps.detect_languages.outputs.languages }}" | grep -q "python"; then
          echo "üêç Running Python quality checks..."
          
          # Syntax check
          if find . -name "*.py" -not -path "./node_modules/*" -not -path "./.git/*" -exec python -m py_compile {} \; 2>&1 | grep -q "SyntaxError"; then
            echo "‚ö†Ô∏è Python syntax errors found"
          else
            echo "‚úÖ Python syntax OK"
          fi
          
          # Run pylint
          if command -v pylint >/dev/null 2>&1; then
            find . -name "*.py" -not -path "./node_modules/*" -not -path "./.git/*" | head -10 | xargs pylint --output=reports/pylint_report.txt || true
          fi
        fi
        
        # JavaScript/TypeScript checks
        if echo "${{ steps.detect_languages.outputs.languages }}" | grep -q "javascript"; then
          echo "üìú Running JavaScript/TypeScript quality checks..."
          
          # ESLint
          if command -v eslint >/dev/null 2>&1; then
            eslint "**/*.{js,jsx,ts,tsx}" --format json --output-file reports/eslint_report.json --no-error-on-unmatched-pattern || true
          fi
          
          # TypeScript compiler check
          if find . -name "tsconfig.json" | grep -q . && command -v tsc >/dev/null 2>&1; then
            tsc --noEmit --skipLibCheck > reports/typescript_errors.txt 2>&1 || true
          fi
        fi
        
        # Go checks
        if echo "${{ steps.detect_languages.outputs.languages }}" | grep -q "golang"; then
          echo "üêπ Running Go quality checks..."
          
          # Go vet
          if command -v go >/dev/null 2>&1; then
            go vet ./... > reports/go_vet.txt 2>&1 || true
          fi
          
          # Go fmt check
          if command -v gofmt >/dev/null 2>&1; then
            gofmt -l . > reports/gofmt_issues.txt 2>&1 || true
          fi
          
          # golangci-lint
          if command -v golangci-lint >/dev/null 2>&1; then
            golangci-lint run --out-format=json > reports/golangci_lint_report.json 2>&1 || true
          fi
          
          # staticcheck
          if command -v staticcheck >/dev/null 2>&1; then
            staticcheck ./... > reports/staticcheck.txt 2>&1 || true
          fi
        fi
        
        echo "‚úÖ Language-specific checks completed"
    
    - name: Pre-flight Syntax Check for Codex
      id: syntax_check
      run: |
        echo "üîç Running pre-flight syntax check for codex.py..."
        
        if [ ! -f "codex.py" ]; then
          echo "‚ùå codex.py not found"
          echo "syntax_status=missing" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Validate Python syntax
        if python -m py_compile codex.py; then
          echo "‚úÖ codex.py syntax is valid"
          echo "syntax_status=valid" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è codex.py has syntax errors, attempting auto-fix..."
          echo "syntax_status=invalid" >> $GITHUB_OUTPUT
          
          # Create backup and attempt fixes
          cp codex.py codex.py.backup
          set +e
          python -c "
          import re
          with open('codex.py', 'r') as f:
              content = f.read()
          
          # Apply common fixes
          lines = content.split('\n')
          fixed_lines = []
          
          for i, line in enumerate(lines, 1):
              # Fix return outside function (line 334)
              if i == 334 and line.strip().startswith('return ') and not any('def ' in l for l in lines[max(0,i-10):i]):
                  fixed_lines.append(f'# FIXED: {line}  # This was outside function')
                  continue
                  
              # Fix undefined variables with safe defaults
              if 'config.output_dir' in line and 'config' not in ' '.join(lines[max(0,i-5):i]):
                  line = line.replace('config.output_dir', 'getattr(config, \\\"output_dir\\\", \\\"output\\\")')
              
              if 'for r in results' in line and 'results' not in ' '.join(lines[max(0,i-5):i]):
                  line = line.replace('for r in results', 'for r in results if \\\"results\\\" in locals() else []')
                  
              fixed_lines.append(line)
          
          with open('codex.py', 'w') as f:
              f.write('\\n'.join(fixed_lines))
          " || echo "Auto-fix completed"
          set -e
        fi
      continue-on-error: true
        
    - name: Run Codex Analysis
      id: codex_run
      run: |
        echo "üöÄ Running Codex Analysis..."
        
        if [ "${{ steps.syntax_check.outputs.syntax_status }}" = "missing" ]; then
          echo "‚ùå codex.py not found - skipping analysis"
          echo "exit_code=2" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Set language-specific flags for Codex
        CODEPLEX_FLAGS="--verbose"
        
        if echo "${{ steps.detect_languages.outputs.languages }}" | grep -q "golang"; then
          CODEPLEX_FLAGS="$CODEPLEX_FLAGS --include-go"
          echo "üîß Including Go language analysis"
        fi
        
        if echo "${{ steps.detect_languages.outputs.languages }}" | grep -q "javascript"; then
          CODEPLEX_FLAGS="$CODEPLEX_FLAGS --include-js --include-ts"
          echo "üîß Including JavaScript/TypeScript analysis"
        fi
        
        set +e
        python codex.py . $CODEPLEX_FLAGS
        exit_code=$?
        set -e
        
        echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        if [ $exit_code -eq 0 ]; then
          echo "‚úÖ Codex analysis completed successfully"
        elif [ $exit_code -eq 2 ]; then
          echo "‚ö†Ô∏è Codex found quality issues (non-critical)"
        else
          echo "‚ùå Codex encountered errors (exit code: $exit_code)"
          echo "::warning::Codex analysis had problems but workflow will continue"
        fi
      continue-on-error: true
    
    - name: Create Multi-Language Fallback Report
      if: steps.codex_run.outputs.exit_code != '0' && steps.codex_run.outputs.exit_code != '2'
      run: |
        echo "üìù Creating multi-language fallback report..."
        mkdir -p reports
        
        python3 -c "
        import json
        import os
        from pathlib import Path
        
        # Language detection patterns
        language_patterns = {
            '.py': 'Python',
            '.js': 'JavaScript',
            '.jsx': 'JavaScript',
            '.ts': 'TypeScript', 
            '.tsx': 'TypeScript',
            '.go': 'Go',
            '.java': 'Java',
            '.cpp': 'C++',
            '.c': 'C',
            '.h': 'C/C++ Header',
            '.rb': 'Ruby',
            '.php': 'PHP',
            '.rs': 'Rust'
        }
        
        files = []
        excluded_dirs = ['node_modules', '.git', 'vendor', '__pycache__', 'dist', 'build']
        
        for ext, lang in language_patterns.items():
            for file_path in Path('.').rglob(f'*{ext}'):
                if not any(excluded in str(file_path) for excluded in excluded_dirs):
                    files.append({
                        'file_path': str(file_path),
                        'language': lang,
                        'success': False,
                        'was_fixed': False,
                        'errors': ['Analysis skipped - Codex execution failed'],
                        'analysis_skipped': True,
                        'file_size': file_path.stat().st_size if file_path.exists() else 0
                    })
        
        detected_langs = list(set([f['language'] for f in files]))
        
        report = {
            'metadata': {
                'total_files': len(files),
                'detected_languages': detected_langs,
                'analyzed_files': 0,
                'skipped_files': len(files),
                'codex_status': 'error',
                'exit_code': '${{ steps.codex_run.outputs.exit_code }}',
                'syntax_status': '${{ steps.syntax_check.outputs.syntax_status }}'
            },
            'files': files[:150]  # Limit output size
        }
        
        with open('reports/multi_language_fallback_report.json', 'w') as f:
            json.dump(report, f, indent=2)
        "
        
        echo "‚úÖ Created fallback report with $(jq '.metadata.total_files' reports/multi_language_fallback_report.json) files across $(jq '.metadata.detected_languages | length' reports/multi_language_fallback_report.json) languages"
    
    - name: Generate Language Summary
      if: always()
      run: |
        echo "üìä Generating language summary..."
        
        python3 -c "
        import json
        from collections import Counter
        import os
        
        summary = {
            'detected_languages': '${{ steps.detect_languages.outputs.languages }}'.split(','),
            'codex_exit_code': '${{ steps.codex_run.outputs.exit_code }}',
            'syntax_status': '${{ steps.syntax_check.outputs.syntax_status }}'
        }
        
        # Count files by language
        lang_counter = Counter()
        for root, dirs, files in os.walk('.'):
            # Skip common excluded directories
            dirs[:] = [d for d in dirs if d not in ['node_modules', '.git', 'vendor', '__pycache__', 'dist', 'build']]
            
            for file in files:
                if file.endswith('.py'): lang_counter['Python'] += 1
                elif file.endswith(('.js', '.jsx')): lang_counter['JavaScript'] += 1
                elif file.endswith(('.ts', '.tsx')): lang_counter['TypeScript'] += 1
                elif file.endswith('.go'): lang_counter['Go'] += 1
                elif file.endswith('.java'): lang_counter['Java'] += 1
                elif file.endswith(('.cpp', '.c', '.h')): lang_counter['C/C++'] += 1
                elif file.endswith('.rb'): lang_counter['Ruby'] += 1
        
        summary['file_counts'] = dict(lang_counter)
        
        with open('reports/language_summary.json', 'w') as f:
            json.dump(summary, f, indent=2)
        "
        
    - name: Ensure reports directory exists
      run: |
        mkdir -p reports
        if [ ! \"\$(ls -A reports 2>/dev/null)\" ]; then
          echo '{\"metadata\": {\"message\": \"No analysis performed\"}, \"files\": []}' > reports/empty_report.json
        fi
        
    - name: Upload Reports and Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codex-multi-language-report
        path: |
          reports/
          codex.py.backup
        retention-days: 7
        if-no-files-found: warn
        
    - name: Comment on PR (Multi-Language Support)
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const syntaxStatus = '${{ steps.syntax_check.outputs.syntax_status }}';
          const exitCode = '${{ steps.codex_run.outputs.exit_code }}';
          const detectedLanguages = '${{ steps.detect_languages.outputs.languages }}'.split(',');
          const runId = process.env.GITHUB_RUN_ID;
          
          // Read language summary
          let fileCounts = {};
          let languageSummary = '';
          
          if (fs.existsSync('reports/language_summary.json')) {
            try {
              const summary = JSON.parse(fs.readFileSync('reports/language_summary.json', 'utf8'));
              fileCounts = summary.file_counts || {};
              
              languageSummary = Object.entries(fileCounts)
                .map(([lang, count]) => `- ${lang}: ${count} files`)
                .join('\\n');
            } catch (e) {
              console.log('Could not read language summary:', e.message);
            }
          }
          
          if (!languageSummary) {
            languageSummary = detectedLanguages.map(lang => `- ${lang}`).join('\\n');
          }
          
          let statusEmoji = '‚ÑπÔ∏è';
          let statusText = 'Multi-Language Analysis';
          let summary = \`Detected languages: ${detectedLanguages.join(', ') || 'None found'}\`;
          
          if (syntaxStatus === 'missing') {
            statusEmoji = '‚ùå';
            statusText = 'CODE NOT FOUND';
            summary = '**codex.py** was not found in the repository.';
          } else if (exitCode === '0') {
            statusEmoji = '‚úÖ';
            statusText = 'ANALYSIS COMPLETED';
            summary = \`Codex analyzed ${Object.values(fileCounts).reduce((a, b) => a + b, 0)} files across ${detectedLanguages.length} languages.\`;
          } else if (exitCode === '2') {
            statusEmoji = '‚ö†Ô∏è';
            statusText = 'QUALITY ISSUES FOUND';
            summary = \`Codex found issues in ${detectedLanguages.length} languages.\`;
          }
          
          const body = \`## ${statusEmoji} Codex Multi-Language Quality Check
          
**Status:** ${statusText}  
${summary}

**Detected Languages:**
${languageSummary}

<details>
<summary>üîß Tools & Linters Used</summary>

- **Python**: pylint, black, flake8, bandit
- **JavaScript/TypeScript**: ESLint, Prettier, TypeScript compiler
- **Go**: golangci-lint, go vet, gofmt, staticcheck
- **Multi-language**: Codex analysis

</details>

<details>
<summary>üìä Download Full Reports</summary>

View detailed analysis in [workflow artifacts](https://github.com/\${process.env.GITHUB_REPOSITORY}/actions/runs/\${runId}).

</details>

---
*Powered by [Codex v6.1.1](https://github.com/FJ-cyberzilla/codex) | Multi-language support enabled*\`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Summary
      if: always()
      run: |
        echo "=== Codex Multi-Language Quality Check Summary ==="
        echo "Detected Languages: ${{ steps.detect_languages.outputs.languages }}"
        echo "Syntax Status: ${{ steps.syntax_check.outputs.syntax_status }}"
        echo "Exit Code: ${{ steps.codex_run.outputs.exit_code }}"
        echo "Reports Generated: $(find reports/ -name '*.json' -o -name '*.txt' 2>/dev/null | wc -l || echo 0)"
        echo ""
        echo "‚úÖ Multi-language quality check completed"
