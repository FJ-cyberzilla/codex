name: Codex Quality Gate

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install Python linters
      run: |
        python -m pip install --upgrade pip
        pip install pylint black flake8 mypy
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install JavaScript linters
      run: |
        npm install -g eslint prettier
        
    - name: Make Codex executable
      run: |
        chmod +x codex.py
        
    - name: Run Codex Analysis (Check Only)
      if: github.event_name == 'pull_request'
      run: |
        python codex.py . --verbose
      continue-on-error: false
        
    - name: Run Codex Analysis with Auto-Fix
      if: github.event_name == 'push'
      run: |
        python codex.py . --fix --verbose
        
    - name: Upload Report Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codex-report-py${{ matrix.python-version }}
        path: reports/
        retention-days: 30
        
    - name: Parse Report for PR Comment
      if: github.event_name == 'pull_request' && matrix.python-version == '3.10'
      id: parse_report
      run: |
        LATEST_REPORT=$(ls -t reports/*.json | head -1)
        TOTAL=$(jq 'length' "$LATEST_REPORT")
        PASSED=$(jq '[.[] | select(.success == true)] | length' "$LATEST_REPORT")
        FAILED=$(jq '[.[] | select(.success == false)] | length' "$LATEST_REPORT")
        FIXED=$(jq '[.[] | select(.was_fixed == true)] | length' "$LATEST_REPORT")
        
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "fixed=$FIXED" >> $GITHUB_OUTPUT
        
    - name: Comment PR with Results
      if: github.event_name == 'pull_request' && matrix.python-version == '3.10'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reports = fs.readdirSync('reports/').filter(f => f.endsWith('.json'));
          const latestReport = reports.sort().reverse()[0];
          const reportData = JSON.parse(fs.readFileSync(`reports/${latestReport}`, 'utf8'));
          
          const total = reportData.length;
          const passed = reportData.filter(r => r.success).length;
          const failed = reportData.filter(r => !r.success).length;
          const fixed = reportData.filter(r => r.was_fixed).length;
          
          const status = failed === 0 ? '‚úÖ' : '‚ùå';
          const statusText = failed === 0 ? 'PASSED' : 'FAILED';
          
          const failedFiles = reportData
            .filter(r => !r.success)
            .map(r => `- \`${r.file_path}\` (${r.language}): ${r.errors.length} error(s)`)
            .join('\n') || 'None';
          
          const body = `## ${status} Codex Quality Gate Report
          
          **Status:** ${statusText}
          **Total Files Analyzed:** ${total}
          **‚úÖ Passed:** ${passed}
          **‚ùå Failed:** ${failed}
          **üîß Auto-Fixed:** ${fixed}
          
          ${failed > 0 ? '‚ö†Ô∏è **Quality gate FAILED** - Please fix the issues before merging.' : '‚úÖ **Quality gate PASSED** - All checks completed successfully!'}
          
          <details>
          <summary>üìã Failed Files (${failed})</summary>
          
          ${failedFiles}
          
          </details>
          
          <details>
          <summary>üìä View Full Report</summary>
          
          Download the full JSON report from the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          
          </details>
          
          ---
          *Generated by [Codex v6.1.1](https://github.com/FJ-cyberzilla/codex) | Commit: \`${context.sha.substring(0, 7)}\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: Generate Badge
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && matrix.python-version == '3.10'
      run: |
        LATEST_REPORT=$(ls -t reports/*.json | head -1)
        FAILED=$(jq '[.[] | select(.success == false)] | length' "$LATEST_REPORT")
        
        if [ "$FAILED" -eq 0 ]; then
          COLOR="brightgreen"
          STATUS="passing"
        else
          COLOR="red"
          STATUS="failing"
        fi
        
        echo "BADGE_COLOR=$COLOR" >> $GITHUB_ENV
        echo "BADGE_STATUS=$STATUS" >> $GITHUB_ENV
        
  security-scan:
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Bandit Security Check
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json || true
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json
        
  notify:
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    if: always()
    
    steps:
    - name: Send Notification
      run: |
        echo "Quality gate completed. Check workflow for results."
        # Add Slack/Discord/Email notification here if needed
